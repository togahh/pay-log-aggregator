apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "pay-log-aggregator.fullname" . }}-test-connection"
  labels:
    {{- include "pay-log-aggregator.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
  - name: connection-test
    image: curlimages/curl:8.4.0
    command:
    - /bin/sh
    - -c
    - |
      echo "Testing Pay Log Aggregator connection..."
      
      # Wait for service to be ready
      for i in $(seq 1 30); do
        if curl -f http://{{ include "pay-log-aggregator.fullname" . }}:{{ .Values.service.port }}/health; then
          echo "Service is healthy"
          break
        fi
        echo "Waiting for service... ($i/30)"
        sleep 2
      done
      
      # Test log ingestion
      echo "Testing log ingestion..."
      curl -X POST "http://{{ include "pay-log-aggregator.fullname" . }}:{{ .Values.service.port }}/logs/ingest" \
        -H "Content-Type: application/json" \
        -d '{
          "level": "INFO",
          "message": "Helm test log message",
          "source": "helm-test",
          "timestamp": "2025-01-01T12:00:00Z"
        }'
      
      # Test health endpoint
      echo "Testing health endpoint..."
      curl -f http://{{ include "pay-log-aggregator.fullname" . }}:{{ .Values.service.port }}/health
      
      {{- if .Values.prometheus.enabled }}
      # Test metrics endpoint
      echo "Testing metrics endpoint..."
      curl -f http://{{ include "pay-log-aggregator.fullname" . }}:{{ .Values.prometheus.port }}/metrics
      {{- end }}
      
      echo "All tests passed successfully!"
  restartPolicy: Never